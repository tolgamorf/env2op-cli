name: Build Windows

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Windows x64 executables
        run: |
          bun build --compile --target=bun-windows-x64 src/cli.ts --outfile dist/env2op.exe
          bun build --compile --target=bun-windows-x64 src/op2env-cli.ts --outfile dist/op2env.exe

      - name: Create ZIP archive
        run: |
          cd dist
          zip -j env2op-windows-x64.zip env2op.exe op2env.exe

      - name: Generate SHASUMS256.txt
        run: |
          cd dist
          sha256sum env2op-windows-x64.zip > SHASUMS256.txt
          cat SHASUMS256.txt

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            dist/env2op-windows-x64.zip \
            dist/SHASUMS256.txt \
            --clobber

      - name: Output summary
        run: |
          echo "## Windows Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assets uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- \`env2op-windows-x64.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`SHASUMS256.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SHA256 Checksums" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat dist/SHASUMS256.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
